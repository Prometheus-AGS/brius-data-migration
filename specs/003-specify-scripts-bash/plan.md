# Implementation Plan: Complete Database Migration Execution

**Branch**: `003-specify-scripts-bash` | **Date**: October 15, 2025 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-specify-scripts-bash/spec.md`

## Summary

Execute the complete database migration workflow to migrate remaining 1.1M+ records across 56+ tables from the legacy PostgreSQL system to the modern Supabase architecture. All existing migration scripts will be utilized in proper dependency order to ensure zero data loss while maintaining 100% referential integrity. Building on completed foundation (offices, categories, profiles), the implementation will systematically migrate core entities (doctors, patients, orders), business operations (tasks, communications, payments), and specialized systems (clinical data, file management) using the existing comprehensive script library.

## Technical Context

**Language/Version**: TypeScript 5.9+ with Node.js 18+
**Primary Dependencies**: @supabase/supabase-js 2.55.0, pg 8.16.3, ts-node 10.9.2, dotenv 17.2.1
**Storage**: PostgreSQL (source: AWS RDS) â†’ Supabase PostgreSQL (target: localhost:54322)
**Testing**: Built-in validation scripts per entity + comprehensive final validation
**Target Platform**: Linux server environment with Node.js runtime
**Project Type**: Single project (data migration with batch processing)
**Performance Goals**: 1.2M+ records migrated with >98% success rate in 2.5-5 hours
**Constraints**: 2GB memory usage max, batch processing (500 records/batch), zero data loss tolerance
**Scale/Scope**: 56+ target tables, 29 migration scripts, 7 execution phases with dependency management

**Technical Context Details - ALL TABLES ACCOUNTED FOR**:
- **Foundation Complete**: offices (523), categories (40), profiles (9,751), brackets (1,569)
- **Core Entities Pending**: doctors (~1,213), patients (~7,854), orders (~23,050)
- **High-Volume Operations**: tasks (762K+), files (294K+), messages (60K+), treatment_plans (67K+), projects (66K+), jaws (39K+)
- **Financial Systems**: offers (393), discounts (135), payments (16K+), customer_feedback (21K+)
- **Clinical Systems**: doctor_notes, comments, case management (cases: 7.8K, case_states, case_messages, case_files)
- **Supporting Systems**: technician_roles (31), communications (783), doctor_offices, message_attachments

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Constitution template is not populated, proceeding with standard quality gates:
- âœ… All migration scripts identified and verified (29 scripts covering 56+ tables)
- âœ… Dependency analysis complete with proper execution order
- âœ… Data integrity preservation mechanisms in place
- âœ… Comprehensive validation and rollback capabilities verified
- âœ… Environment configuration validated

## Project Structure

### Documentation (this feature)

```
specs/003-specify-scripts-bash/
â”œâ”€â”€ plan.md                                    # This implementation plan
â”œâ”€â”€ research.md                                # Complete script inventory & analysis
â”œâ”€â”€ data-model.md                              # Migration execution data structures
â”œâ”€â”€ quickstart.md                              # Step-by-step execution guide
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ migration-execution.contract.md       # CLI interface & API contracts
â””â”€â”€ tasks.md                                   # (Generated by /tasks command)
```

### Migration Scripts (repository root) - ALL TABLES ACCOUNTED FOR

```
src/                                           # NPM-managed migration scripts
â”œâ”€â”€ office-migration.ts                       # âœ… COMPLETED (523 records)
â”œâ”€â”€ profile-migration.ts                      # âœ… COMPLETED (9,751 records)
â”œâ”€â”€ doctor-migration.ts                       # ðŸ”„ PENDING (~1,213 records)
â”œâ”€â”€ patient-migration.ts                      # ðŸ”„ PENDING (~7,854 records)
â”œâ”€â”€ orders-migration.ts                       # ðŸ”„ PENDING (~23,050 records)
â”œâ”€â”€ products-migration.ts                     # ðŸ”„ PENDING (~10 records)
â”œâ”€â”€ jaws-migration.ts                         # ðŸ”„ PENDING (~39,771 records)
â”œâ”€â”€ projects-migration.ts                     # ðŸ”„ PENDING (~66,918 records)
â”œâ”€â”€ treatment-plans-migration.ts              # ðŸ”„ PENDING (~67,782 records)
â”œâ”€â”€ patients-complete-migration-pg.ts         # Alternative patient migration
â”œâ”€â”€ differential-migration.ts                 # Advanced migration system
â””â”€â”€ types/migration-types.ts                  # TypeScript definitions

migrate-*.ts                                   # Direct execution scripts
â”œâ”€â”€ migrate-tasks.ts                          # ðŸ”„ PENDING (~762,604 records)
â”œâ”€â”€ migrate-cases.ts                          # ðŸ”„ PENDING (~7,853 records)
â”œâ”€â”€ migrate-dispatch-records.ts               # ðŸ”„ PENDING (~60,944 messages)
â”œâ”€â”€ migrate-communications.ts                 # ðŸ”„ PENDING (~783 records)
â”œâ”€â”€ migrate-order-files.ts                   # ðŸ”„ PENDING (~294,818 files)
â”œâ”€â”€ migrate-case-files-optimized.ts          # ðŸ”„ PENDING (case documentation)
â”œâ”€â”€ migrate-offers-and-discounts-fixed.ts    # ðŸ”„ PENDING (393 offers, 135 discounts)
â”œâ”€â”€ migrate-purchases-fixed.ts               # ðŸ”„ PENDING (~16,011 payments)
â”œâ”€â”€ migrate-doctor-notes.ts                  # ðŸ”„ PENDING (~962 notes)
â”œâ”€â”€ migrate-comments-proper-architecture.ts  # ðŸ”„ PENDING (comment system)
â”œâ”€â”€ migrate-categories.ts                    # âœ… COMPLETED (40 records)
â”œâ”€â”€ migrate-technician-roles-complete.ts     # ðŸ”„ PENDING (31 roles, 32 technicians)
â”œâ”€â”€ migrate-brackets-with-schema.ts          # âœ… COMPLETED (1,569 records)
â”œâ”€â”€ migrate-doctor-offices.ts                # ðŸ”„ PENDING (~74 relationships)
â”œâ”€â”€ migrate-customer-feedback.ts             # ðŸ”„ PENDING (~21,595 records)
â”œâ”€â”€ migrate-case-states.ts                   # ðŸ”„ PENDING (case state management)
â”œâ”€â”€ migrate-case-messages.ts                 # ðŸ”„ PENDING (case communications)
â”œâ”€â”€ migrate-message-attachments.ts           # ðŸ”„ PENDING (attachment system)
â””â”€â”€ migrate-dispatch-state-fixed.ts          # ðŸ”„ PENDING (system state data)

validation/                                    # Validation & quality assurance
â”œâ”€â”€ validate-*-migration.ts                  # Entity-specific validation (15+ scripts)
â”œâ”€â”€ final-migration-validation.ts            # Comprehensive system validation
â”œâ”€â”€ check-migration-status.ts                # Real-time status monitoring
â””â”€â”€ verify-migration-results.ts              # Results verification

configuration/
â”œâ”€â”€ .env                                      # âœ… Database connections configured
â”œâ”€â”€ package.json                             # âœ… All NPM scripts defined
â””â”€â”€ tsconfig.json                            # TypeScript configuration

logs/                                         # Generated during execution
â”œâ”€â”€ migration-YYYYMMDD.log                   # Daily migration logs
â”œâ”€â”€ audit/                                   # Audit trail preservation
â””â”€â”€ checkpoints/                             # Recovery checkpoints
```

**Structure Decision**: This is a single-project migration system utilizing the existing comprehensive script library. All 56+ target tables have corresponding migration scripts, with 29 primary migration scripts covering complete data transformation. The structure supports both NPM-managed scripts (for core entities with dependency handling) and direct TypeScript execution (for specialized business operations).

### Complete Table Coverage Verification

**Core Entities (NPM Scripts)**:
- âœ… offices â†’ doctors â†’ patients â†’ orders â†’ products â†’ jaws â†’ projects â†’ treatment_plans

**Business Operations (Direct Scripts)**:
- ðŸ”„ tasks, cases, messages, communications, order_files, case_files

**Financial Systems**:
- ðŸ”„ offers, discounts, payments, purchases, customer_feedback

**Clinical Systems**:
- ðŸ”„ doctor_notes, comments, case_states, case_messages, message_attachments

**System Configuration**:
- âœ… categories, brackets (complete)
- ðŸ”„ technician_roles, technicians, doctor_offices

**Total Coverage**: 29 migration scripts â†’ 56+ target tables â†’ 1.2M+ records

## Complexity Tracking

*No constitutional violations identified. All complexity justified by business requirements.*

| Complexity Area | Business Justification | Alternative Considered |
|-----------------|------------------------|------------------------|
| 29 Migration Scripts | Each table requires specialized transformation logic | Single script rejected: data relationships too complex |
| 7 Execution Phases | Dependency management prevents foreign key violations | Parallel execution rejected: referential integrity risk |
| Dual Script Types | NPM scripts for core entities, direct for specialized operations | Single approach rejected: different complexity levels require different handling |
| Batch Processing | Memory management for 762K+ task records | Full-memory loading rejected: system resource constraints |

## Implementation Phases - ALL TABLES ACCOUNTED FOR

### Phase 0: Prerequisites âœ… COMPLETE
- Environment configuration verified
- Database connections established
- Foundation data confirmed (offices: 523, categories: 40, profiles: 9,751, brackets: 1,569)

### Phase 1: Core Entity Migrations ðŸ”„ READY TO EXECUTE
**Priority**: Critical (blocks all dependent operations)
**Expected Duration**: 30-60 minutes
**Expected Records**: ~32,000

```bash
# Execute in dependency order
npm run migrate:doctors                    # ~1,213 doctors (depends: offices)
npm run validate:doctors                   # Verify completion

npm run migrate:patients                   # ~7,854 patients (depends: doctors, offices)
npm run validate:patients                  # Verify completion

npm run migrate:orders                     # ~23,050 orders (depends: patients, doctors)
npm run validate:orders                    # Verify completion
```

**Success Criteria**: 100% referential integrity, >99% record success rate

### Phase 2: High-Volume Business Operations ðŸ”„ PENDING
**Priority**: Critical for business continuity
**Expected Duration**: 60-120 minutes
**Expected Records**: ~1,100,000

```bash
# Large datasets - execute sequentially with monitoring
ts-node migrate-tasks.ts                  # ~762,604 workflow tasks (largest dataset)
ts-node migrate-cases.ts                  # ~7,853 patient cases
ts-node migrate-dispatch-records.ts       # ~60,944 clinical messages
ts-node migrate-order-files.ts            # ~294,818 treatment files

# Validation checkpoints
ts-node validate-task-migration.ts
ts-node validate-case-migration.ts
```

**Success Criteria**: >98% success rate despite volume, complete file integrity

### Phase 3: Financial & Product Systems ðŸ”„ PENDING
**Priority**: Zero-tolerance for financial data loss
**Expected Duration**: 30-60 minutes
**Expected Records**: ~38,000

```bash
# Financial operations (critical accuracy)
npm run migrate:products                   # ~10 product records
ts-node migrate-offers-and-discounts-fixed.ts  # 393 offers, 135 discounts ($4M+ value)
ts-node migrate-purchases-fixed.ts        # ~16,011 payments
ts-node migrate-customer-feedback.ts      # ~21,595 feedback records

# Validation - financial accuracy mandatory
ts-node validate-offers-discounts-migration.ts
```

**Success Criteria**: 100% financial data accuracy, complete audit trail

### Phase 4: Clinical & Advanced Systems ðŸ”„ PENDING
**Priority**: Important for full feature parity
**Expected Duration**: 45-90 minutes
**Expected Records**: ~175,000

```bash
# Clinical data systems
npm run migrate:jaws                       # ~39,771 orthodontic analysis
npm run migrate:treatment-plans            # ~67,782 treatment specifications
npm run migrate:projects                   # ~66,918 project management
ts-node migrate-doctor-notes.ts           # ~962 clinical notes
ts-node migrate-comments-proper-architecture.ts  # Comment system

# Validation
npm run validate:jaws
npm run validate:treatment-plans
npm run validate:projects
```

**Success Criteria**: Complete clinical data integrity, treatment history preserved

### Phase 5: Supporting Systems & Relationships ðŸ”„ PENDING
**Priority**: Supporting functionality
**Expected Duration**: 15-30 minutes
**Expected Records**: ~25,000

```bash
# System configuration and relationships
ts-node migrate-technician-roles-complete.ts    # 31 roles, 32 technicians
ts-node migrate-communications.ts               # ~783 team communications
ts-node migrate-doctor-offices.ts               # ~74 doctor-office relationships

# Relationship and state tables
ts-node migrate-case-states.ts                  # Case state management
ts-node migrate-case-messages.ts                # Case communications
ts-node migrate-case-files-optimized.ts         # Case file attachments
ts-node migrate-message-attachments.ts          # Message attachment system
```

**Success Criteria**: All relationships properly established, role management functional

### Phase 6: State Management & Completion ðŸ”„ PENDING
**Priority**: System completeness
**Expected Duration**: 15-30 minutes
**Expected Records**: Variable

```bash
# Final state and system data
ts-node migrate-dispatch-state-fixed.ts         # System state data

# Comprehensive validation
npm run validate:final                           # Complete system validation
ts-node final-migration-validation.ts           # Comprehensive final check
npm run check:migration-status                   # Status verification
```

**Success Criteria**: 100% system completeness, all validations pass

## Execution Strategy

### Recommended Approach: Sequential Phase Execution
1. **Complete each phase** before proceeding to next
2. **Validate after each major entity** migration
3. **Monitor resource usage** during high-volume phases
4. **Checkpoint frequently** during large migrations
5. **Validate financial data** with zero-tolerance accuracy

### Alternative Approach: NPM Managed Workflow
```bash
# Use pre-configured dependency chains for core entities
npm run migrate:core-with-patients              # Handles offices + profiles + doctors + patients
npm run migrate:orders-with-deps                # Full dependency chain through orders

# Then continue with business operations phases
```

### Emergency Procedures
```bash
# Stop and rollback if success rate < 95%
npm run rollback:orders
npm run rollback:patients
npm run rollback:doctors

# Resume from checkpoint for large migrations
ts-node migrate-tasks.ts --resume
```

## Quality Assurance Framework

### Pre-Flight Checks âœ… COMPLETE
- [x] Database connectivity verified (source + target)
- [x] Environment variables validated
- [x] Foundation data confirmed (offices, categories, profiles, brackets)
- [x] All 29 migration scripts present and accessible
- [x] Sufficient disk space (>5GB free)
- [x] Memory allocation adequate (2GB+ available)

### Real-Time Monitoring
```bash
# Progress tracking
tail -f logs/migration-$(date +%Y%m%d).log

# Resource monitoring
htop                                            # Memory and CPU usage
df -h                                           # Disk space

# Database status
npm run check:migration-status                  # Real-time migration status
```

### Post-Migration Validation
- [ ] Record count verification (Â±1% tolerance acceptable)
- [ ] Referential integrity check (zero violations required)
- [ ] Financial data accuracy (100% for monetary values)
- [ ] Clinical data completeness (all message history preserved)
- [ ] UUID mapping completeness (100% legacy ID preservation)
- [ ] Performance validation (query response times acceptable)

## Risk Mitigation

### High-Risk Operations & Mitigations
1. **Tasks Migration (762K records)**
   - Risk: Memory exhaustion, processing timeout
   - Mitigation: Batch size 500, checkpoint every 10K records

2. **Financial Data Migration ($4M+ value)**
   - Risk: Data corruption, calculation errors
   - Mitigation: Transaction-level validation, 100% accuracy requirement

3. **File Migration (294K files)**
   - Risk: Storage exhaustion, broken references
   - Mitigation: Storage verification, reference integrity checks

4. **Dependency Chain Violations**
   - Risk: Foreign key failures, orphaned records
   - Mitigation: Strict phase execution, pre-validation checks

## Success Metrics & Completion Criteria

### Quantitative Targets
- **Total Records Migrated**: 1,200,000+ across 56+ tables
- **Overall Success Rate**: >98% (matching historical performance)
- **Core Entity Success**: >99% (doctors, patients, orders)
- **Financial Accuracy**: 100% (zero tolerance for monetary errors)
- **Referential Integrity**: 100% (zero foreign key violations)
- **Execution Time**: 2.5-5 hours total duration
- **Memory Usage**: <2GB peak utilization

### Qualitative Criteria
- âœ… All 29 migration scripts successfully executed
- âœ… Complete audit trail generated and preserved
- âœ… Legacy ID mappings created for all entities
- âœ… Validation reports generated for all phases
- âœ… System ready for production deployment

## Final Deliverables

Upon completion, the following will be delivered:

### Migrated Data
- **56+ fully populated target tables** with complete data integrity
- **1.2M+ migrated records** across all business domains
- **Complete legacy ID mappings** for backward compatibility
- **Preserved relationships** maintaining referential integrity

### Documentation & Audit
- **Comprehensive migration logs** with timestamp and status tracking
- **Validation reports** confirming data quality and completeness
- **Performance metrics** documenting execution statistics
- **Audit trail** meeting compliance requirements

### System Readiness
- **Production-ready database** with optimized performance
- **Complete business functionality** across all domains
- **Validated data integrity** with comprehensive quality checks
- **Recovery capabilities** via complete rollback support

---

## Progress Tracking

### Phase Completion Status
- [x] **Phase 0**: Prerequisites & Environment âœ… COMPLETE
- [ ] **Phase 1**: Core Entities (doctors, patients, orders) ðŸ”„ READY
- [ ] **Phase 2**: High-Volume Operations (tasks, cases, messages, files) ðŸ”„ PENDING
- [ ] **Phase 3**: Financial & Product Systems ðŸ”„ PENDING
- [ ] **Phase 4**: Clinical & Advanced Systems ðŸ”„ PENDING
- [ ] **Phase 5**: Supporting Systems & Relationships ðŸ”„ PENDING
- [ ] **Phase 6**: State Management & Final Validation ðŸ”„ PENDING

### Overall Implementation Status
**Status**: READY FOR EXECUTION - All planning phases complete, comprehensive plan established

**Next Action**: Execute Phase 1 (Core Entities) using NPM scripts with dependency management

**Expected Completion**: All 56+ tables migrated with 1.2M+ records within 2.5-5 hours

---

**Implementation Plan Complete**: Comprehensive migration strategy established ensuring ALL tables with available scripts are properly accounted for and will be migrated in correct dependency order with full data integrity preservation.
